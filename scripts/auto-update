#!/usr/bin/env ruby
# Auto-update script for pixoo-kid-weather
# Checks GitHub for new commits and pulls them if available

require "open3"

APP_ROOT = File.expand_path("..", __dir__)
Dir.chdir(APP_ROOT)

class AutoUpdater
  def initialize
    @branch = current_branch
    @updated = false
    @gemfile_changed = false
  end

  def run
    log "Checking for updates on #{@branch}..."

    unless git_available?
      log "Git not available, skipping update check"
      return false
    end

    unless remote_configured?
      log "No remote configured, skipping update check"
      return false
    end

    # Fetch latest from origin
    unless fetch_origin
      log "Failed to fetch from origin (network issue?), continuing with current version"
      return false
    end

    # Check if we're behind
    local_sha = git("rev-parse HEAD").strip
    remote_sha = git("rev-parse @{u}").strip

    if local_sha == remote_sha
      log "Already up to date (#{local_sha[0..6]})"
      return false
    end

    behind_count = git("rev-list --count HEAD..@{u}").strip.to_i
    log "#{behind_count} new commit(s) available"

    # Check if Gemfile will change
    @gemfile_changed = !git("diff HEAD..@{u} --name-only -- Gemfile Gemfile.lock").strip.empty?

    # Pull changes
    log "Pulling updates..."
    result, status = git_with_status("pull --ff-only")

    if status.success?
      new_sha = git("rev-parse HEAD").strip
      log "Updated: #{local_sha[0..6]} â†’ #{new_sha[0..6]}"
      @updated = true

      if @gemfile_changed
        log "Gemfile changed, running bundle install..."
        system("bundle install")
      end

      return true
    else
      log "Pull failed (merge conflict?): #{result}"
      return false
    end
  end

  def updated?
    @updated
  end

  private

  def log(msg)
    puts "[AutoUpdate] #{msg}"
  end

  def git_available?
    system("git --version > /dev/null 2>&1")
  end

  def remote_configured?
    !git("remote").strip.empty?
  end

  def current_branch
    git("rev-parse --abbrev-ref HEAD").strip
  end

  def fetch_origin
    # Retry with exponential backoff
    delays = [2, 4, 8, 16]

    result, status = git_with_status("fetch origin #{@branch}")
    return true if status.success?

    delays.each do |delay|
      log "Fetch failed, retrying in #{delay}s..."
      sleep delay
      result, status = git_with_status("fetch origin #{@branch}")
      return true if status.success?
    end

    false
  end

  def git(cmd)
    `git #{cmd} 2>/dev/null`
  end

  def git_with_status(cmd)
    stdout, stderr, status = Open3.capture3("git #{cmd}")
    [stdout + stderr, status]
  end
end

if __FILE__ == $0
  updater = AutoUpdater.new
  updated = updater.run

  # Exit codes:
  # 0 = updated successfully
  # 1 = no updates available or update failed
  exit(updated ? 0 : 1)
end
